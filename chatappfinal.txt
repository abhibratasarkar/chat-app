import express from "express";
import { createServer } from "node:http";
import { Server } from "socket.io";

const app = express();
const server = createServer(app);
const io = new Server(server);

// Serve static files for socket.io.js

// Route: Homepage
app.get("/", (req, res) => {
  res.send(`
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Chat Rooms</title>
      <style>
        body {
          background-color: #202123; /* Dark grey background */
          color: #D1D5DB; /* Light grey text */
          font-family: Arial, sans-serif;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          height: 100vh;
          margin: 0;
        }
        h1 {
          margin-bottom: 20px;
        }
        input, button {
          margin: 5px;
          padding: 10px;
          font-size: 16px;
          border: 1px solid #4B5563; /* Border matches grey theme */
          border-radius: 4px;
          background-color: #1F2937; /* Dark input background */
          color: #D1D5DB;
        }
        button {
          cursor: pointer;
        }
        button:hover {
          background-color: #374151;
        }
        input:focus, button:focus {
          outline: none;
          border-color: #6366F1; /* Focus with indigo color */
        }
      </style>
    </head>
    <body>
      <h1>Join a Chat Room</h1>
      <input id="username" placeholder="Enter your username" />
      <input id="room" placeholder="Enter your room" />
      <button id="enterButton">Enter Room</button>

      <script>
        const enterButton = document.getElementById('enterButton');
        enterButton.addEventListener('click', () => {
          const username = document.getElementById('username').value.trim();
          const room = document.getElementById('room').value.trim();

          if (username && room) {
            window.location.href = \`/chatapp/\${username}/\${room}\`;
          } else {
            alert('Please fill in both fields!');
          }
        });
      </script>
    </body>
    </html>
  `);
});

// Route: Chat room
app.get("/chatapp/:username/:room", (req, res) => {
  const { username, room } = req.params;

  res.send(`
    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Chat Room: ${room}</title>
      <style>
        body {
          background-color: #202123;
          color: #D1D5DB;
          font-family: Arial, sans-serif;
          display: flex;
          flex-direction: column;
          height: 100vh;
          margin: 0;
        }
        #messages {
          flex: 1;
          list-style-type: none;
          margin: 0;
          padding: 10px;
          overflow-y: auto;
        }
        #messages > li {
          padding: 10px;
          margin-bottom: 10px;
          background-color: #1F2937;
          border-radius: 4px;
        }
        #form {
          display: flex;
          padding: 10px;
          border-top: 1px solid #4B5563;
          background-color: #111827;
        }
        #input {
          flex: 1;
          padding: 10px;
          font-size: 16px;
          border: 1px solid #4B5563;
          border-radius: 4px;
          background-color: #1F2937;
          color: #D1D5DB;
        }
        button {
          margin-left: 10px;
          padding: 10px;
          font-size: 16px;
          border: 1px solid #4B5563;
          border-radius: 4px;
          background-color: #374151;
          color: #D1D5DB;
          cursor: pointer;
        }
        button:hover {
          background-color: #4B5563;
        }
      </style>
    </head>
    <body>
      <ul id="messages"></ul>
      <form id="form">
        <input id="input" autocomplete="off" placeholder="Type a message..." />
        <button type="submit">Send</button>
      </form>

      <script src="/socket.io/socket.io.js"></script>
      <script>
        const socket = io();
        const form = document.getElementById('form');
        const input = document.getElementById('input');
        const messages = document.getElementById('messages');

        // Join the chat room
        socket.emit('joinRoom', '${room}');

        // Send a message
        form.addEventListener('submit', (e) => {
          e.preventDefault();
          const message = input.value.trim();
          if (message) {
            socket.emit('chatMessage', { room: '${room}', message });
            input.value = '';
          }
        });

        // Receive messages
        socket.on('chatMessage', (msg) => {
          const item = document.createElement('li');
          item.textContent = msg;
          messages.appendChild(item);
          messages.scrollTop = messages.scrollHeight; // Auto-scroll
        });
      </script>
    </body>
    </html>
  `);
});

// Socket.io: Handle real-time events
io.on("connection", (socket) => {
  socket.on("joinRoom", (room) => {
    socket.join(room);
    console.log(`User joined room: ${room}`);
  });

  socket.on("chatMessage", ({ room, message }) => {
    io.to(room).emit("chatMessage", message);
  });
});

// Start server
server.listen(3000, "0.0.0.0", () => {
  console.log("Server running on port 3000");
});
